<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>Automatic Migration - My Study Note</title>
        <link href="../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../../css/brands.min.css" rel="stylesheet">
        <link href="../../../css/solid.min.css" rel="stylesheet">
        <link href="../../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../..">My Study Note</a>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#automatic-migration" class="nav-link">Automatic Migration</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#set-environment-variables" class="nav-link">Set Environment Variables</a>
              <ul class="nav flex-column">
              </ul>
            </li>
            <li class="nav-item" data-bs-level="2"><a href="#demo" class="nav-link">Demo</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="automatic-migration">Automatic Migration</h1>
<p>This is a simple example of how to use the automatic migration feature of Atlas.</p>
<h2 id="set-environment-variables">Set Environment Variables</h2>
<p>atlas.hcl</p>
<pre><code class="language-hcl">env &quot;local&quot; {
  name = &quot;local&quot;
  url = &quot;sqlite3://my-version-db.db&quot;
  dev = &quot;sqlite3://my-dev-db.db&quot;
}
</code></pre>
<h2 id="demo">Demo</h2>
<ol>
<li>Create a new database called my-auto-db.db</li>
</ol>
<pre><code class="language-bash">sqlite3 my-auto-db.db
</code></pre>
<ol>
<li>Check the status of the migration</li>
</ol>
<pre><code class="language-bash">atlas migrate status --env local
</code></pre>
<ol>
<li>Create initial migration scripts in the migrations folder</li>
</ol>
<pre><code class="language-bash">atlas migrate new create_table_users
</code></pre>
<ol>
<li>Rehash the status of the migration</li>
</ol>
<pre><code class="language-bash">atlas migrate status --env local
</code></pre>
<ol>
<li>Apply the migration scripts in the migrations folder</li>
</ol>
<pre><code class="language-bash">atlas migrate apply --env local
</code></pre>
<ol>
<li>Check the status of the migration</li>
</ol>
<pre><code class="language-bash">atlas migrate status --env local
</code></pre>
<h3 id="apply-automatic-migration">Apply automatic migration</h3>
<p>Instead of writing the sql scripts manually to change the database schema, you can use the automatic migration feature of Atlas to generate the sql scripts for you.  Here is how you can do it:</p>
<ol>
<li>Modify the schema.hcl file by adding email column to the users table.</li>
</ol>
<pre><code class="language-sql">create table users (
  id integer primary key,
  name text not null,
  email text not null,
  created_at timestamp not null default current_timestamp,
  updated_at timestamp not null
);
</code></pre>
<ol>
<li>Use atlas migrate diff</li>
</ol>
<pre><code class="language-bash">atlas migrate diff --env local add_email
</code></pre>
<p>atlas will generate the sql script for you and save it in the migrations folder.  The file name will be in the format of <code>YYYYMMDDHHMMSS_add_email.sql</code>.</p>
<pre><code>├── migrations
│   ├── 20241211051223_create_table_users.sql
│   ├── 20241211072414_add_email.sql
│   └── atlas.sum

</code></pre>
<ol>
<li>Add blog_posts table to the schema.sql file</li>
</ol>
<pre><code class="language-sql">create table blog_posts (
  id integer primary key,
  title text not null,
  content text not null,
  user_id integer not null,
  created_at timestamp not null default current_timestamp,
  updated_at timestamp not null,
  foreign key (user_id) references users(id)
);
</code></pre>
<ol>
<li>Let atlas generate the sql script for you</li>
</ol>
<pre><code class="language-bash">atlas migrate diff --env local add_blog_posts

├── migrations
│   ├── 20241211051223_create_table_users.sql
│   ├── 20241211072414_add_email.sql
│   ├── 20241211073508_add_blog_posts.sql
│   └── atlas.sum

</code></pre>
<ol>
<li>Let drop the blog_posts table</li>
</ol>
<pre><code class="language-sql">drop table blog_posts;
</code></pre>
<ol>
<li>Let atlas generate the sql script for you</li>
</ol>
<pre><code class="language-bash">atlas migrate diff --env local drop_blog_posts
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js"></script>
        <script src="../../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
